FROM ubuntu:12.04
ENV NAGIOS_HOME /opt/nagios
ENV NAGIOS_USER nagios
ENV NAGIOS_GROUP nagios
ENV NAGIOS_CMDUSER nagios
ENV NAGIOS_CMDGROUP nagios
ENV NAGIOS_CGI_CONFIG /etc/nagios/cgi.cfg
ENV NAGIOSADMIN_USER nagiosadmin
ENV NAGIOSADMIN_PASS nagios

RUN sed -i 's/main$/main universe/' /etc/apt/sources.list
RUN echo "deb http://au.archive.ubuntu.com/ubuntu/ precise universe" >> /etc/apt/sources.list
RUN echo "deb-src http://au.archive.ubuntu.com/ubuntu/ precise universe" >> /etc/apt/sources.list
RUN echo "deb http://au.archive.ubuntu.com/ubuntu/ precise-updates universe" >> /etc/apt/sources.list
RUN echo "deb-src http://au.archive.ubuntu.com/ubuntu/ precise-updates universe" >> /etc/apt/sources.list


RUN echo "deb http://security.ubuntu.com/ubuntu precise main universe" >> /etc/apt/sources.list
RUN apt-get update && apt-get install -y inetutils-ping build-essential snmp snmpd wget php5-cli apache2 libapache2-mod-php5 ca-certificates sudo curl git-core 
RUN ( egrep -i  "^${NAGIOS_GROUP}" /etc/group || groupadd $NAGIOS_GROUP ) && ( egrep -i "^${NAGIOS_CMDGROUP}" /etc/group || groupadd $NAGIOS_CMDGROUP )
RUN ( id -u $NAGIOS_USER || useradd $NAGIOS_USER -g $NAGIOS_GROUP -d $NAGIOS_HOME ) && ( id -u $NAGIOS_CMDUSER || useradd -d $NAGIOS_HOME -g $NAGIOS_CMDGROUP $NAGIOS_CMDUSER )
RUN cd /tmp && wget http://prdownloads.sourceforge.net/sourceforge/nagios/nagios-4.0.2.tar.gz
RUN cd /tmp && tar -zxvf nagios-4.0.2.tar.gz && cd nagios-4.0.2  && ./configure --prefix=${NAGIOS_HOME} --exec-prefix=/opt/nagios --disable-statusmap --disable-statuswrl --enable-event-broker --with-nagios-command-user=${NAGIOS_CMDUSER} --with-command-group=${NAGIOS_CMDGROUP} --with-nagios-user=${NAGIOS_USER} --with-nagios-group=${NAGIOS_GROUP} && make all
RUN cd /tmp && wget --no-check-certificate http://www.nagios-plugins.org/download/nagios-plugins-1.5.tar.gz
RUN cd /tmp && tar -zxvf nagios-plugins-1.5.tar.gz && cd nagios-plugins-1.5 && ./configure --prefix=/opt/nagios && make
RUN sed -i.bak 's/.*\=www\-data//g' /etc/apache2/envvars
RUN echo "export APACHE_RUN_USER=$(echo $NAGIOS_CMDUSER)" >> /etc/apache2/envvars
RUN echo "export APACHE_RUN_GROUP=$(echo $NAGIOS_CMDGROUP)" >> /etc/apache2/envvars
RUN export DOC_ROOT="DocumentRoot $(echo $NAGIOS_HOME/share)"; sed -i "s,DocumentRoot.*,$DOC_ROOT," /etc/apache2/sites-enabled/000-default

RUN cd /tmp/nagios-4.0.2 && make install && make install-commandmode && make install-webconf
RUN cd /tmp/nagios-plugins-1.5 && make install
RUN mkdir -p /var/nagios/spool/checkresults && chown -R ${NAGIOS_USER}:${NAGIOS_GROUP} /var/nagios
RUN ln -s /opt/nagios/bin/nagios /usr/local/bin/nagios
RUN mkdir /etc/nagios && chown ${NAGIOS_USER}:${NAGIOS_GROUP} /etc/nagios
RUN htpasswd -c -b -s /etc/nagios/htpasswd.users ${NAGIOSADMIN_USER} ${NAGIOSADMIN_PASS}
RUN env --unset NAGIOSADMIN_PASS
RUN sed -i 's,/opt/nagios/etc,/etc/nagios,g' /etc/apache2/conf.d/nagios.conf
RUN echo "SetEnv NAGIOS_CGI_CONFIG $NAGIOS_CGI_CONFIG" >> /etc/apache2/conf.d/nagios.conf
RUN cd /tmp/nagios-4.0.2 && make install-config
RUN mkdir -p /var/nagios/rw /etc/nagios
RUN cp -rp ${NAGIOS_HOME}/etc/* /etc/nagios/

RUN chown -R ${NAGIOS_USER}.${NAGIOS_GROUP} /var/nagios /etc/nagios

RUN apt-get install -y rubygems 
RUN gem install --verbose fpm

RUN mv /etc/apache2/sites-available/default /etc/apache2/sites-available/nagios

ADD pre-install.sh /tmp/pre-install.sh
RUN fpm -s dir -t deb --verbose --deb-user ${NAGIOS_USER} --deb-group ${NAGIOS_GROUP} -n nagios -v 4.0.2 --before-install /tmp/pre-install.sh /etc/nagios/ /opt/nagios/ /var/nagios/ /etc/apache2/sites-available/nagios /etc/apache2/conf.d/nagios.conf /etc/nagios/htpasswd.users

ADD start.sh /usr/local/bin/start_nagios
RUN chmod +x /usr/local/bin/start_nagios
CMD ["/usr/local/bin/start_nagios"]
EXPOSE 80
